<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Civilisa’Sceaux — Aventure Égyptienne (Test local)</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
<!-- SheetJS pour export .xlsx -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0c0f16; --panel:#101622; --ink:#e8ecf6; --muted:#aab4c8; --accent:#f6c453; --accent-2:#1f2b44; --ok:#4ade80; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0f17,#0c0f16);color:var(--ink);font-family:Manrope,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1000px;margin:24px auto;padding:16px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .brand{font-weight:800;letter-spacing:.3px}
  .card{background:var(--panel);border:1px solid rgba(246,196,83,.25);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  h1,h2,h3{margin:.2em 0 .4em}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1 1 320px}
  .btn{display:inline-block;background:var(--accent);color:#1b1405;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid var(--accent);color:var(--accent)}
  .btn.small{padding:6px 10px;border-radius:10px;font-weight:700}
  input[type="text"]{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #2a344b;background:#0d1320;color:#e7edff}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #1c2436;text-align:left}
  th{color:#cbd6ea}
  .timer{font-variant-numeric:tabular-nums;font-size:1.125rem;background:#0e1524;border:1px dashed #2a3550;border-radius:12px;padding:10px 12px;display:inline-block}
  .progress{height:10px;border-radius:10px;background:#151b29;border:1px solid #2a3550;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,#f6c453,#e6b02e);width:0%}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f1626;border:1px solid #2a3550;color:#cbd6ea;font-size:.85rem}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .encouragement{font-style:italic;color:#d7e5ff}
  .finale{
    position:relative; height:260px; border-radius:16px; overflow:hidden;
    background:radial-gradient(120% 90% at 50% 10%, #443114 0%, #2b1f0d 45%, #1c1409 100%);
    border:1px solid rgba(246,196,83,.35);
  }
  .finale::after{
    content:"Papyrus sacré — symbole à déchiffrer";
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    color:#f3e4c2;font-weight:800;font-size:1.2rem;letter-spacing:.8px;text-shadow:0 1px 0 #000;
    filter:blur(14px);
    transition:filter .4s ease;
  }
  .finale.unlock::after{filter:blur(0)}
  .notice{background:#0e1628;border-left:4px solid #3b82f6;padding:12px;border-radius:10px}
  .grid-steps{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .stepcard{border:1px solid #2a3550;border-radius:12px;padding:12px;background:#0e1524}
  code{background:#0e1524;border:1px solid #2a3550;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="brand">🦂 Civilisa’Sceaux — <span style="color:var(--accent)">Aventure Égyptienne</span> (test local)</div>
    <div class="pill">Maître du jeu : <strong>Stefanubis</strong></div>
  </header>

  <!-- Vue dynamique -->
  <div id="app"></div>

</div>

<script>
/* ========= CONFIG JEU (test local) ========= */
const GAME = {
  gameId: "egypt-local-001",
  title: "Aventure Égyptienne",
  gm: "Stefanubis",
  steps: [
    {id:"egy1", word:"ANUBIS", points:1, msg:"Stefanubis chuchote : le sable garde les secrets…"},
    {id:"egy2", word:"PAPYRUS", points:1, msg:"Les dieux observent. Un code de plus, courage !"},
    {id:"egy3", word:"SCARABEE", points:1, msg:"Tu marches dans les pas d’un scribe habile."},
    {id:"egy4", word:"SPHINX", points:1, msg:"Le Nil t’encourage, continue l’exploration !"},
    {id:"egy5", word:"NIL", points:1, msg:"Le vent du désert porte ton nom au panthéon…"},
    {id:"egy6", word:"PHARAON", points:1, msg:"Le scarabée roule… ta chance aussi."},
    {id:"egy7", word:"ANKH", points:1, msg:"Ton papyrus se dévoile, signe après signe."},
    {id:"egy8", word:"BASTET", points:1, msg:"La lumière de Râ éclaire ta piste."},
    {id:"egy9", word:"PYRAMIDE", points:1, msg:"Plus que quelques symboles à graver…"},
    {id:"egy10", word:"OSIRIS", points:1, msg:"Le dernier secret t’attend, va au bout !"}
  ],
  // Heure limite : vendredi 16:00 (en supposant fuseau local Europe/Paris)
  cutoffHour: 16
};

// Clés localStorage
const KEY_META = "civ_game_meta";
const KEY_PLAYERS = "civ_players";
const KEY_SESSION = "civ_session";

/* ========= UTIL ========= */
const $ = sel => document.querySelector(sel);
const app = $("#app");

function now(){ return new Date(); }

function toISO(d){ return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,19)+getTZISO(); }
function getTZISO(){
  // Renvoie l'offset local au format ±HH:MM
  const off = -new Date().getTimezoneOffset(); // minutes east of UTC
  const sign = off>=0?"+":"-";
  const abs = Math.abs(off);
  const h = String(Math.floor(abs/60)).padStart(2,"0");
  const m = String(abs%60).padStart(2,"0");
  return sign+h+":"+m;
}

function loadMeta(){
  const raw = localStorage.getItem(KEY_META);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch(e){ return null; }
}
function saveMeta(meta){ localStorage.setItem(KEY_META, JSON.stringify(meta)); }
function ensureMeta(){
  let meta = loadMeta();
  if(!meta){
    meta = { gameId: GAME.gameId, gm: GAME.gm, startAt: toISO(now()), endAt: toISO(nextFridayAt(GAME.cutoffHour)) };
    saveMeta(meta);
  }
  return meta;
}
function resetMetaStartIfNewWeek(){
  // Si l’endAt est passé ET qu’on relance, on redéfinit un nouveau cycle semaine
  let meta = loadMeta();
  if(!meta) return ensureMeta();
  const end = new Date(meta.endAt);
  if(now() > end){
    meta.startAt = toISO(now());
    meta.endAt = toISO(nextFridayAt(GAME.cutoffHour));
    saveMeta(meta);
  }
  return meta;
}

function loadPlayers(){
  const raw = localStorage.getItem(KEY_PLAYERS);
  if(!raw) return {};
  try { return JSON.parse(raw) } catch(e){ return {}; }
}
function savePlayers(obj){ localStorage.setItem(KEY_PLAYERS, JSON.stringify(obj)); }

function setSession(pseudo){ localStorage.setItem(KEY_SESSION, pseudo); }
function getSession(){ return localStorage.getItem(KEY_SESSION) || ""; }

function sanitizeWord(s){ return (s||"").trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); }

function nextFridayAt(hour=16){
  const d = new Date();
  const day = d.getDay(); // 0=Dim ... 5=Ven
  const target = new Date(d);
  let add = 5 - day;
  if(add < 0) add += 7;
  // Si on est vendredi mais après l’heure, on passe à la semaine suivante
  if(add===0){
    if(d.getHours() > hour || (d.getHours()===hour && (d.getMinutes()>0 || d.getSeconds()>0))){
      add = 7;
    }
  }
  target.setDate(d.getDate()+add);
  target.setHours(hour,0,0,0);
  return target;
}

function msToDHMS(ms){
  if(ms<0) return {d:0,h:0,m:0,s:0};
  const s = Math.floor(ms/1000);
  const d = Math.floor(s/86400);
  const h = Math.floor((s%86400)/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return {d,h,m,sec};
}

function isEnded(meta){
  return now() > new Date(meta.endAt);
}

/* ========= CLASSEMENT ========= */
function computeLeaderboard(players){
  const list = Object.entries(players).map(([pseudo,st])=>{
    const found = (st.found||[]).length;
    const score = st.score||found; // au cas où
    return {pseudo, found, score, lastTs: st.lastTs||null};
  });
  list.sort((a,b)=>{
    if(b.score !== a.score) return b.score - a.score;
    if(a.lastTs && b.lastTs) return new Date(a.lastTs) - new Date(b.lastTs);
    if(a.lastTs && !b.lastTs) return -1;
    if(!a.lastTs && b.lastTs) return 1;
    return a.pseudo.localeCompare(b.pseudo);
  });
  return list;
}

/* ========= EXPORT XLSX ========= */
function exportXLSX(){
  const players = loadPlayers();
  const leaderboard = computeLeaderboard(players);
  const meta = loadMeta() || ensureMeta();

  // Sheet 1 — Leaderboard
  const sheet1 = [["pseudo","total_codes","score","last_update"]];
  leaderboard.forEach(r=>{
    sheet1.push([r.pseudo, r.found, r.score, r.lastTs||""]);
  });

  // Sheet 2 — Journal (plat)
  const sheet2 = [["pseudo","stepId","word","timestamp"]];
  Object.entries(players).forEach(([pseudo,st])=>{
    (st.journal||[]).forEach(j=>{
      sheet2.push([pseudo, j.stepId, j.word, j.ts]);
    });
  });

  // Workbook
  const wb = XLSX.utils.book_new();
  const ws1 = XLSX.utils.aoa_to_sheet(sheet1);
  const ws2 = XLSX.utils.aoa_to_sheet(sheet2);
  XLSX.utils.book_append_sheet(wb, ws1, "Leaderboard");
  XLSX.utils.book_append_sheet(wb, ws2, "Journal");
  const fname = `aventures-egyptiennes_${(meta.endAt||"").slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, fname);
}

/* ========= ROUTER (hash) ========= */
const routes = {
  "": renderIndex,
  "#/": renderIndex,
  "#/intro": renderIntro,
  // Steps dynamiques #/egy1 ... #/egy10
  // Finale
  "#/finale": renderFinale
};

window.addEventListener("hashchange", () => route());
document.addEventListener("DOMContentLoaded", () => route());

function route(){
  const h = location.hash || "#/";
  if(h.startsWith("#/egy")){
    renderStep(h.slice(2)); // "egy1"
    return;
  }
  const view = routes[h] || renderIndex;
  view();
}

/* ========= VUES ========= */
let timerInterval;

function renderIndex(){
  const meta = resetMetaStartIfNewWeek();
  const players = loadPlayers();
  const leaderboard = computeLeaderboard(players);

  clearInterval(timerInterval);
  document.getElementById("app").innerHTML = \`
    <div class="card">
      <h1>📜 Aventures</h1>
      <p class="muted">Pour l’instant : <strong>Aventure Égyptienne</strong>. Saisis ton pseudo, lance la quête, trouve les <strong>10 codes</strong> (1 pt chacun) avant <strong>vendredi \${new Date(meta.endAt).toLocaleString('fr-FR')}</strong>.</p>
      <div class="row">
        <div class="col">
          <div class="card">
            <h2>🏺 Aventure Égyptienne</h2>
            <div class="timer" id="timer">Calcul du compte à rebours…</div>
            <div style="margin-top:12px">
              <button class="btn" id="btnStart">Lancer / Continuer</button>
              <button class="btn ghost small" id="btnIntro">Changer/Entrer mon pseudo</button>
            </div>
            <div style="margin-top:16px" class="notice">
              <strong>Infos :</strong> stockage <em>local</em> (même appareil). Maître du jeu : <em>Stefanubis</em>.
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <h3>🏆 Classement local</h3>
            <table>
              <thead><tr><th>Pseudo</th><th>Codes</th><th>Score</th><th>Dernière maj</th></tr></thead>
              <tbody>
                \${leaderboard.length? leaderboard.map(r=>\`
                  <tr>
                    <td>\${escapeHTML(r.pseudo)}</td>
                    <td>\${r.found}/\${GAME.steps.length}</td>
                    <td>\${r.score}</td>
                    <td>\${r.lastTs? new Date(r.lastTs).toLocaleString('fr-FR'): ""}</td>
                  </tr>
                \`).join("") : \`<tr><td colspan="4" class="muted">Aucun joueur pour l’instant.</td></tr>\`}
              </tbody>
            </table>
            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn ghost small" id="btnExport">Exporter .xlsx</button>
              <button class="btn ghost small" id="btnResetWeek">Relancer semaine</button>
              <button class="btn ghost small" id="btnClearAll">Effacer TOUT (test)</button>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>📘 Aide rapide</h3>
        <div class="grid-steps">
          <div class="stepcard"><strong>1.</strong> Va sur <code>Lancer</code> (ou <code>Changer/Entrer mon pseudo</code>)</div>
          <div class="stepcard"><strong>2.</strong> Trouve les codes (1 pt chacun) et valide sur chaque page <code>egy1…egy10</code></div>
          <div class="stepcard"><strong>3.</strong> Le papyrus final se défloute si tu as tout trouvé</div>
          <div class="stepcard"><strong>4.</strong> Le classement se met à jour sur cet appareil</div>
        </div>
      </div>
    </div>
  \`;

  // Timer
  const $timer = document.getElementById("timer");
  function tick(){
    const ms = new Date(meta.endAt) - now();
    const t = msToDHMS(ms);
    if(ms <= 0){
      $timer.textContent = "⏳ Jeu terminé — en pause jusqu’au prochain lancement.";
      clearInterval(timerInterval);
    }else{
      $timer.textContent = \`⏳ Temps restant : \${t.d}j \${String(t.h).padStart(2,"0")}h \${String(t.m).padStart(2,"0")}m \${String(t.sec).padStart(2,"0")}s\`;
    }
  }
  tick();
  timerInterval = setInterval(tick, 1000);

  // Boutons
  document.getElementById("btnStart").onclick = ()=>{
    const pseudo = getSession();
    if(!pseudo) location.hash = "#/intro";
    else location.hash = "#/egy1";
  };
  document.getElementById("btnIntro").onclick = ()=> location.hash = "#/intro";
  document.getElementById("btnExport").onclick = exportXLSX;
  document.getElementById("btnResetWeek").onclick = ()=>{
    const meta = ensureMeta();
    meta.startAt = toISO(now());
    meta.endAt = toISO(nextFridayAt(GAME.cutoffHour));
    saveMeta(meta);
    route();
  };
  document.getElementById("btnClearAll").onclick = ()=>{
    if(confirm("Effacer toutes les données locales (joueurs + méta) ?")){
      localStorage.removeItem(KEY_META);
      localStorage.removeItem(KEY_PLAYERS);
      localStorage.removeItem(KEY_SESSION);
      route();
    }
  };
}

function renderIntro(){
  const meta = ensureMeta();
  clearInterval(timerInterval);
  document.getElementById("app").innerHTML = \`
    <div class="card">
      <h2>🎭 Choisis ton pseudo/prénom</h2>
      <p class="muted">Il servira à sauvegarder ta progression <em>sur cet appareil</em>.</p>
      <div class="row">
        <div class="col">
          <label for="pseudo">Pseudo / Prénom</label>
          <input type="text" id="pseudo" placeholder="Ex. Léa, Léo, Chloé…" value="\${escapeHTML(getSession())}">
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="btnSave">Enregistrer & commencer</button>
            <button class="btn ghost" id="btnBack">Retour</button>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <h3>⏳ Échéance</h3>
            <div class="timer">Fin : \${new Date(meta.endAt).toLocaleString('fr-FR')}</div>
            <p class="muted" style="margin-top:8px">Au-delà, la quête est en pause. Stefanubis publie le classement.</p>
          </div>
        </div>
      </div>
    </div>
  \`;
  document.getElementById("btnSave").onclick = ()=>{
    const p = (document.getElementById("pseudo").value||"").trim();
    if(!p){ alert("Entre un pseudo/prénom."); return; }
    setSession(p);
    // initialise joueur si besoin
    const players = loadPlayers();
    if(!players[p]){
      players[p] = {found:[], score:0, lastTs:null, journal:[]};
      savePlayers(players);
    }
    location.hash = "#/egy1";
  };
  document.getElementById("btnBack").onclick = ()=> location.hash = "#/";
}

function renderStep(stepId){
  // stepId type "egy1"
  const pseudo = getSession();
  const meta = ensureMeta();
  const ended = isEnded(meta);

  const step = GAME.steps.find(s=>s.id===stepId);
  if(!step){ document.getElementById("app").innerHTML = \`<div class="card">Étape introuvable.</div>\`; return; }

  const players = loadPlayers();
  if(!pseudo || !players[pseudo]){
    document.getElementById("app").innerHTML = \`
      <div class="card">
        <h2>Tu n’as pas de session active</h2>
        <p class="muted">Renseigne un pseudo pour commencer.</p>
        <button class="btn" onclick="location.hash='#/intro'">Aller à l’intro</button>
      </div>\`;
    return;
  }
  const state = players[pseudo];
  const foundSet = new Set(state.found || []);
  const already = foundSet.has(step.id);

  // progress
  const total = GAME.steps.length;
  const val = (state.found||[]).length;
  const pct = Math.round(val/total*100);

  clearInterval(timerInterval);
  document.getElementById("app").innerHTML = \`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h2>🏺 Étape \${step.id.toUpperCase()}</h2>
        <div class="pill">Joueur : <strong>\${escapeHTML(pseudo)}</strong></div>
      </div>
      <div class="encouragement">“\${escapeHTML(step.msg)}”</div>
      <div style="margin:12px 0">
        <div class="progress"><div class="bar" style="width:\${pct}%"></div></div>
        <div class="muted" style="margin-top:6px">\${val}/\${total} codes validés</div>
      </div>
      <div class="notice" style="margin-top:12px">
        <strong>Consigne :</strong> saisis le <em>mot-code</em> trouvé sur le terrain (test sans QR).
      </div>
      <div class="row" style="margin-top:12px">
        <div class="col">
          <label for="codeInput">Mot-code</label>
          <input type="text" id="codeInput" placeholder="Ex. ANUBIS" \${ended ? "disabled":""}>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="btnValider" \${ended ? "disabled":""}>Valider</button>
            <button class="btn ghost" id="btnPrev">← Étape précédente</button>
            <button class="btn ghost" id="btnNext">Étape suivante →</button>
            <button class="btn ghost" id="btnHome">Retour aventures</button>
          </div>
          <div id="feedback" style="margin-top:10px"></div>
        </div>
        <div class="col">
          <div class="card">
            <h3>⏳ Fin de l’édition</h3>
            <div class="timer">\${new Date(meta.endAt).toLocaleString('fr-FR')}</div>
            <p class="muted" style="margin-top:6px">\${ended? "Jeu terminé — en pause." : "Temps restant visible sur la page Aventures."}</p>
          </div>
          <div class="card">
            <h3>🗺️ Navigation</h3>
            <div style="display:flex;flex-wrap:wrap;gap:8px">
              \${GAME.steps.map(s=>\`<a class="btn small \${s.id===step.id?'':'ghost'}" href="#/\${s.id}">\${s.id.toUpperCase()}</a>\`).join("")}
              <a class="btn small ghost" href="#/finale">Finale</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  \`;

  document.getElementById("btnPrev").onclick = ()=>{
    const idx = GAME.steps.findIndex(s=>s.id===step.id);
    location.hash = "#/"+(GAME.steps[idx-1]?.id || "egy1");
  };
  document.getElementById("btnNext").onclick = ()=>{
    const idx = GAME.steps.findIndex(s=>s.id===step.id);
    location.hash = "#/"+(GAME.steps[idx+1]?.id || "finale");
  };
  document.getElementById("btnHome").onclick = ()=> location.hash = "#/";

  document.getElementById("btnValider").onclick = ()=>{
    if(ended){ setFeedback("Jeu terminé — en pause.", false); return; }
    const valIn = sanitizeWord(document.getElementById("codeInput").value);
    const target = sanitizeWord(step.word);
    if(!valIn){ setFeedback("Entre un mot-code.", false); return; }

    // cooldown soft : anti-spam (2s) — on laisse minimal ici
    const nowISO = toISO(now());

    if(valIn === target){
      if(!already){
        state.found = Array.from(new Set([...(state.found||[]), step.id]));
        state.score = (state.score||0) + (step.points||1);
        state.lastTs = nowISO;
        state.journal = [...(state.journal||[]), {stepId:step.id, word:step.word, ts:nowISO}];
        players[pseudo] = state;
        savePlayers(players);
        setFeedback(\`✅ Correct ! +\${step.points||1} point.\`, true);
        // rafraîchir barre
        renderStep(step.id);
      }else{
        setFeedback("✅ Déjà validé pour ce joueur.", true);
      }
    }else{
      setFeedback("❌ Mauvais code. Réessaie.", false);
    }
  };

  function setFeedback(msg, ok){
    document.getElementById("feedback").innerHTML = \`<div class="\${ok?'ok':'bad'}">\${escapeHTML(msg)}</div>\`;
  }
}

function renderFinale(){
  const pseudo = getSession();
  const players = loadPlayers();
  const state = players[pseudo] || {found:[]};
  const total = GAME.steps.length;
  const val = (state.found||[]).length;
  const unlocked = val>=total;

  clearInterval(timerInterval);
  document.getElementById("app").innerHTML = \`
    <div class="card">
      <h2>🏁 Papyrus final</h2>
      <p class="muted">Le papyrus est flou au départ. Il se révèle quand <strong>tous les \${total}</strong> codes sont validés.</p>
      <div class="finale \${unlocked?'unlock':''}" style="margin:10px 0 12px"></div>
      <div class="row">
        <div class="col">
          <div class="progress"><div class="bar" style="width:\${Math.round(val/total*100)}%"></div></div>
          <p class="muted" style="margin-top:6px">\${val}/\${total} codes validés pour <strong>\${escapeHTML(pseudo||'—')}</strong></p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <a class="btn ghost" href="#/egy1">Revenir aux étapes</a>
            <a class="btn ghost" href="#/">Aventures / Classement</a>
            <button class="btn" id="btnExport">Exporter .xlsx</button>
          </div>
        </div>
        <div class="col">
          <div class="notice">
            <strong>Bravo !</strong> Quand l’image est nette, “Stefanubis” peut déclarer le vainqueur et remettre la récompense.
          </div>
        </div>
      </div>
    </div>
  \`;
  document.getElementById("btnExport").onclick = exportXLSX;
}

/* ========= HELPERS ========= */
function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]||m)); }

</script>
</body>
</html>
